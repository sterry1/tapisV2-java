# security container and core container and worker contianers
# can swivel to use aloe.dev or staging backends rabbit and mongodb.
#
#
meta-security:
   image: tapis/metaapi:0.0.5-T2dev
   restart: "always"
   log_driver: json-file
   log_opt:
      max-size: 100m
      max-file: "5"
   command: catalina.sh run
   container_name: meta-tapis-security-tst
   links:
      - restheart
   ports:
      - "8199:8080"
   environment:
      - 'aloe.envonly.keystore.password=Umg&FR7VwWL*04lj8vd+'
      - 'aloe.envonly.skip.jwt.verify=true'
      - 'aloe_envonly_jwt_optional=false'
      - 'tapis.meta.mongo.lrq.uri=mongodb://tapisadmin:d3f%40ult@aloe-dev08.tacc.utexas.edu:27019/?authSource=admin&authMechanism=SCRAM-SHA-1'
      - 'tapis.meta.core.server=http://restheart:8080/'
      - 'tapis.meta.coreserver.connection.timeout=5'
      - 'tapis.log.directory=/usr/local/tomcat/logs'
      - 'tapis.log.file=meta-service.log'
      - 'tapis.meta.security.permissions.file=/opt/tomcat/etc/permissions.json'
      - 'tapis.meta.queue.workers=10'
      - 'tapis.meta.query.host=aloe-dev08.tacc.utexas.edu'
      - 'tapis.meta.query.port=27019'
      - 'tapis.meta.query.user=tapisadmin'
      - 'tapis.meta.query.password=d3f@ult'
      - 'tapis.meta.query.authDB=admin'
      - 'tapis.meta.queue.host=aloe-dev08.tacc.utexas.edu'
      - 'tapis.meta.queue.port=5672'
      - 'tapis.meta.queue.user=guest'
      - 'tapis.meta.queue.password=guest'
      - 'CATALINA_OPTS=-Xms1g -Xmx2g -Dlogback.configurationFile=/opt/tomcat/etc/logback.xml'
      - 'tapis.meta.queue.name=lrq-vdjserver.org'
      - 'tapis.meta.data.dir=lrqdata'
      - 'tapis.meta.tenant.default.storage=irplus/data/lrqdata'

   volumes:
      - '/Users/sterry1/var/log/splunk/meta-security:/usr/local/tomcat/logs'
      - './keystores/.AloeKeyStore.p12:/root/.AloeKeyStore.p12'
      - './etc/permissions.json:/opt/tomcat/etc/permissions.json'
      - './etc/logback.xml:/opt/tomcat/etc/logback.xml'

restheart:
   image: jenkins2.tacc.utexas.edu:5000/tapis/tapis-meta-rh-core:4.1.6
   restart: "always"
   log_driver: json-file
   log_opt:
      max-size: 100m
      max-file: "5"
   container_name: restheart-core
   # command: 'java -Xms2G -Xmx2G -Dfile.encoding=UTF-8  -server -jar restheart.jar etc/restheart.yml --envFile etc/config.properties'
   command: 'java -Dfile.encoding=UTF-8  -server -jar restheart.jar etc/restheart.yml --envFile etc/config.properties'
   ports:
      - "8080:8080"
   environment:
      - 'MONGO_URI=mongodb://tapisadmin:d3f%40ult@aloe-dev08.tacc.utexas.edu:27019/?authSource=admin'
   volumes:
      - './etc/restheart.yml:/opt/restheart/etc/restheart.yml:ro'
      - './etc/config.properties:/opt/restheart/etc/config.properties:ro'
      - '/var/log/splunk/meta-security:/var/log'


# security container and core container for Aloe development
# environment tag 0.0.1-T2dev to distinguish from regular metaV3 security contatiner.
#
meta-worker:
   image: tapis/metawrkr:0.0.4-T2dev
   restart: "always"
   log_driver: json-file
   log_opt:
      max-size: 100m
      max-file: "5"
   command: "java -Xms1g -Xmx2g -Dlogback.configurationFile=/metawrkr/logback.xml -cp metawrkr.jar:lib/* edu/utexas/tacc/tapis/meta/LRQWorker"
   container_name: meta-tapis-wrkr-tst
   environment:
      - 'tapis.meta.mongo.lrq.uri=mongodb://tapisadmin:d3f%40ult@aloe-dev08.tacc.utexas.edu:27019/?authSource=admin&authMechanism=SCRAM-SHA-1'
      - 'tapis.log.directory=/metawrkr/logs'
      - 'tapis.log.file=meta-worker.log'
      - 'tapis.meta.query.host=aloe-dev08.tacc.utexas.edu'
      - 'tapis.meta.query.port=27019'
      - 'tapis.meta.query.user=tapisadmin'
      - 'tapis.meta.query.password=d3f@ult'
      - 'tapis.meta.query.authDB=admin'
      - 'tapis.meta.queue.workers=10'
      - 'tapis.meta.queue.host=aloe-dev08.tacc.utexas.edu'
      - 'tapis.meta.queue.port=5672'
      - 'tapis.meta.queue.user=guest'
      - 'tapis.meta.queue.password=guest'
      - 'JAVA_OPTS=-Xms1g -Xmx2g -Dlogback.configurationFile=/metawrkr/logback.xml'
      - 'tapis.meta.queue.name=lrq-vdjserver.org'
      - 'tapis.meta.tenant=vdjserver.org'
      - 'tapis.meta.data.dir=lrqdata'
      - 'tapis.meta.tenant.default.storage=irplus/data/lrqdata'


   volumes:
      - '/Users/sterry1/var/log/splunk/meta-worker:/metawrkr/logs'
      - './etc/logback.xml:/metawrkr/logback.xml'
      - './lrqdata:/metawrkr/lrqdata'

mongodb:
   image: mongo:4.2
   container_name: restheart-mongo
   command: "mongod --auth --bind_ip_all"
   environment:
      MONGO_INITDB_ROOT_USERNAME: 'tapisadmin'
      MONGO_INITDB_ROOT_PASSWORD: 'd3fault'
   volumes:
      - "./mongodb/dbdata:/data/db"
   ### mongodb port must be mapped for the test to run
   ports:
      - "27017:27017"

rabbitmq:
   image: rabbitmq:3.7.16-management
   container_name: tapis-rabbitmq
   labels:
      name: tapis-rabbitmq
   restart: on-failure
   ports:
      - '4369:4369'
      - '5671:5671'
      - '5672:5672'
      - '15671:15671'
      - '15672:15672'
      - '25672:25672'

