# security container and core container for Aloe development
# environment tag 0.0.1-T2dev to distinguish from regular metaV3 security contatiner.
#
meta-security:
  image: jenkins2.tacc.utexas.edu:5000/tapis/metaapi:0.0.5-T2dev
  restart: "always"
  log_driver: json-file
  log_opt:
    max-size: 100m
    max-file: "5"
  command: catalina.sh run
  container_name: meta-tapis-security-tst
  links:
    - restheart
  ports:
    - "8199:8080"
  environment:
    - 'aloe.envonly.keystore.password=Umg&FR7VwWL*04lj8vd+'
    - 'aloe.envonly.skip.jwt.verify=true'
    - 'aloe_envonly_jwt_optional=false'
    - 'tapis.meta.mongo.lrq.uri=mongodb://129.114.58.190:27017'
    - 'tapis.meta.core.server=http://restheart:8080/'
    - 'tapis.meta.coreserver.connection.timeout=5'
    - 'tapis.log.directory=/usr/local/tomcat/logs'
    - 'tapis.log.file=meta-service.log'
    - 'tapis.meta.security.permissions.file=/opt/tomcat/etc/permissions.json'
    - 'tapis.meta.query.host=129.114.58.190'
    - 'tapis.meta.query.port=27017'
    - 'tapis.meta.query.user='
    - 'tapis.meta.query.password='
    - 'tapis.meta.query.authDB='
    - 'tapis.meta.queue.host=vdj-lrq.tacc.utexas.edu'
    - 'tapis.meta.queue.port=5672'
    - 'tapis.meta.queue.user=guest'
    - 'tapis.meta.queue.password=guest'
    - 'CATALINA_OPTS=-Xms1g -Xmx2g -Dlogback.configurationFile=/opt/tomcat/etc/logback.xml'
    - 'tapis.meta.queue.name=lrq-vdjserver.org'

  volumes:
    - '/var/log/splunk/meta-security:/usr/local/tomcat/logs'
    - './keystores/.AloeKeyStore.p12:/root/.AloeKeyStore.p12'
    - './etc/permissions.json:/opt/tomcat/etc/permissions.json'
    - './etc/logback.xml:/opt/tomcat/etc/logback.xml'

restheart:
  image: jenkins2.tacc.utexas.edu:5000/tapis/tapis-meta-rh-core:4.1.6
  restart: "always"
  log_driver: json-file
  log_opt:
    max-size: 100m
    max-file: "5"
  container_name: restheart-core
  # command: 'java -Xms2G -Xmx2G -Dfile.encoding=UTF-8  -server -jar restheart.jar etc/restheart.yml --envFile etc/config.properties'
  command: 'java -Dfile.encoding=UTF-8  -server -jar restheart.jar etc/restheart.yml --envFile etc/config.properties'
  ports:
    - "8080:8080"
  environment:
    - 'MONGO_URI=mongodb://129.114.58.190:27017'
  volumes:
    - './etc/restheart.yml:/opt/restheart/etc/restheart.yml:ro'
    - './etc/config.properties:/opt/restheart/etc/config.properties:ro'
    - '/var/log/splunk/meta-security:/var/log'
